<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  <div id="titlebar">
    <div class="title">DPS Viewer</div>
    <div class="title-buttons">
      <button id="min">━</button>
      <button id="close">✕</button>
    </div>
  </div>
  <div id="controls">
    <button id="clearBtn">清空所有统计数据</button>
  </div>
  <canvas id="barChart" width="350" height="250"></canvas>
  <div id="noData" style="display: none;">暂无用户数据</div>

  <script>
    Chart.register(ChartDataLabels);

    const ctx = document.getElementById('barChart').getContext('2d');
    const noDataDiv = document.getElementById('noData');
    const clearBtn = document.getElementById('clearBtn');

    const barChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: '总伤害',
          data: [],
          backgroundColor: [],
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'center',
            align: 'center',
            color: 'white',
            font: { weight: 'bold', size: 12 },
            formatter: value => value.toLocaleString()
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            display: false   // 隐藏 X 轴
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // 根据数值大小返回5档颜色
    function getColorByValue(value, min, max) {
      const colors = [
        'rgba(255, 99, 132, 0.6)',   // 红
        'rgba(255, 159, 64, 0.6)',   // 橙
        'rgba(255, 205, 86, 0.6)',   // 黄
        'rgba(75, 192, 192, 0.6)',   // 绿
        'rgba(54, 162, 235, 0.6)'    // 蓝
      ];
      const range = max - min || 1;  // 防止除零
      const step = range / 5;

      if (value <= min + step) return colors[0];
      else if (value <= min + step * 2) return colors[1];
      else if (value <= min + step * 3) return colors[2];
      else if (value <= min + step * 4) return colors[3];
      else return colors[4];
    }

    async function fetchAndUpdate() {
      try {
        const res = await fetch('http://localhost:8989/api/data');
        const data = await res.json();

        const users = Object.entries(data.user || {}).map(([id, info]) => ({
          id,
          total: info.total_damage.total
        }));

        const topUsers = users.sort((a, b) => b.total - a.total).slice(0, 20);

        if (topUsers.length === 0) {
          barChart.data.labels = [];
          barChart.data.datasets[0].data = [];
          barChart.data.datasets[0].backgroundColor = [];
          barChart.update();
          noDataDiv.style.display = 'block';
        } else {
          noDataDiv.style.display = 'none';

          const labels = topUsers.map(u => `用户 ${u.id}`);
          const values = topUsers.map(u => u.total);

          const minVal = Math.min(...values);
          const maxVal = Math.max(...values);
          const colors = values.map(v => getColorByValue(v, minVal, maxVal));

          barChart.data.labels = labels;
          barChart.data.datasets[0].data = values;
          barChart.data.datasets[0].backgroundColor = colors;
          barChart.update();
        }
      } catch (e) {
        noDataDiv.textContent = '数据加载失败';
        noDataDiv.style.display = 'block';
        console.error('请求失败:', e);
      }
    }

    clearBtn.onclick = async () => {
      try {
        const res = await fetch('http://localhost:8989/api/clear');
        if (res.ok) {
          alert('数据已清空');
          fetchAndUpdate();
        } else {
          alert('清空失败');
        }
      } catch (e) {
        alert('清空请求失败');
        console.error(e);
      }
    };

    fetchAndUpdate();
    setInterval(fetchAndUpdate, 1000);

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('min')?.addEventListener('click', () => {
        window.electronAPI.minimize();
      });

      document.getElementById('close')?.addEventListener('click', () => {
        window.electronAPI.close();
      });
    });
  </script>
</body>
</html>
